---
slug: /references/medusa-workflows/computeDraftOrderAdjustmentsWorkflow
sidebar_label: computeDraftOrderAdjustmentsWorkflow
sidebar_description: Refresh the promotions in a draft order.
tags:
  - locking
  - order
  - promotion
  - query
  - workflow
---

import { TypeList, WorkflowDiagram } from "docs-ui"

# computeDraftOrderAdjustmentsWorkflow - Medusa Core Workflows Reference

This documentation provides a reference to the `computeDraftOrderAdjustmentsWorkflow`. It belongs to the `@medusajs/medusa/core-flows` package.

This workflow computes the adjustments or promotions for a draft order. It's used by other workflows
to compute new adjustments for the promotions whenever changes are made to the draft order.
Created adjustments are "virtual" meaning they live on the action and no line item adjustments records are created
in the database until the edit is confirmed.

You can use this workflow within your customizations or your own custom workflows, allowing you to wrap custom logic around
computing the adjustments for a draft order.

:::note

If you use this workflow in another, you must acquire a lock before running it and release the lock after. Learn more in the [Locking Operations in Workflows](https://docs.medusajs.com/learn/fundamentals/workflows/locks#locks-in-nested-workflows) guide.

:::

<SourceCodeLink link="https://github.com/medusajs/medusa/blob/a960fb75c9f662372fd5cd623f883f9d6d8ad473/packages/core/core-flows/src/draft-order/workflows/compute-draft-order-adjustments.ts#L61" />

## Examples

<CodeTabs group="workflow-exection">
    <CodeTab label="API Route" value="api-route">
    
```ts title="src/api/workflow/route.ts"
import type {
  MedusaRequest,
  MedusaResponse,
} from "@medusajs/framework/http"
import { computeDraftOrderAdjustmentsWorkflow } from "@medusajs/medusa/core-flows"

export async function POST(
  req: MedusaRequest,
  res: MedusaResponse
) {
  const { result } = await computeDraftOrderAdjustmentsWorkflow(req.scope)
    .run({
      input: {
        order_id: "order_123",
      }
    })

  res.send(result)
}
```

    </CodeTab>
    <CodeTab label="Subscriber" value="subscriber">
    
```ts title="src/subscribers/order-placed.ts"
import {
  type SubscriberConfig,
  type SubscriberArgs,
} from "@medusajs/framework"
import { computeDraftOrderAdjustmentsWorkflow } from "@medusajs/medusa/core-flows"

export default async function handleOrderPlaced({
  event: { data },
  container,
}: SubscriberArgs < { id: string } > ) {
  const { result } = await computeDraftOrderAdjustmentsWorkflow(container)
    .run({
      input: {
        order_id: "order_123",
      }
    })

  console.log(result)
}

export const config: SubscriberConfig = {
  event: "order.placed",
}
```

    </CodeTab>
    <CodeTab label="Scheduled Job" value="scheduled-job">
    
```ts title="src/jobs/message-daily.ts"
import { MedusaContainer } from "@medusajs/framework/types"
import { computeDraftOrderAdjustmentsWorkflow } from "@medusajs/medusa/core-flows"

export default async function myCustomJob(
  container: MedusaContainer
) {
  const { result } = await computeDraftOrderAdjustmentsWorkflow(container)
    .run({
      input: {
        order_id: "order_123",
      }
    })

  console.log(result)
}

export const config = {
  name: "run-once-a-day",
  schedule: "0 0 * * *",
}
```

    </CodeTab>
    <CodeTab label="Another Workflow" value="another-workflow">
    
```ts title="src/workflows/my-workflow.ts"
import { createWorkflow } from "@medusajs/framework/workflows-sdk"
import { computeDraftOrderAdjustmentsWorkflow } from "@medusajs/medusa/core-flows"

const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    // Acquire lock from nested workflow here
    // acquireLockStep({  key: input.order_id,  timeout: 2,  ttl: 10,  })
    const result = computeDraftOrderAdjustmentsWorkflow
      .runAsStep({
        input: {
          order_id: "order_123",
        }
      })
    // Release lock here
    // releaseLockStep({ key: input.order_id })
  }
)
```

    </CodeTab>
  </CodeTabs>

## Steps

<WorkflowDiagram workflow={{"name":"computeDraftOrderAdjustmentsWorkflow","steps":[{"type":"step","name":"acquireLockStep","description":"This step acquires a lock for a given key. Learn more about locks in the [Locking Module](https://docs.medusajs.com/resources/infrastructure-modules/locking)\nguide.","link":"../../../../Locking/Steps_Locking/functions/core_flows.Locking.Steps_Locking.acquireLockStep/page.mdx","depth":1},{"type":"when","condition":"toDeleteActions.length > 0","depth":"2","steps":[{"type":"step","name":"deleteOrderChangeActionsStep","description":"This step deletes order change actions.","link":"../../../../Order/Steps_Order/functions/core_flows.Order.Steps_Order.deleteOrderChangeActionsStep/page.mdx","depth":2}]},{"type":"step","name":"previewOrderChangeStep","description":"This step retrieves a preview of an order change.","link":"../../../../Order/Steps_Order/functions/core_flows.Order.Steps_Order.previewOrderChangeStep/page.mdx","depth":3},{"type":"when","condition":"!!order.promotions?.length","depth":"5","steps":[{"type":"step","name":"getActionsToComputeFromPromotionsStep","description":"This step retrieves the actions to compute based on the promotions\napplied on items and shipping methods.\n\n:::tip\n\nYou can use the [retrieveCartStep](../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.retrieveCartStep/page.mdx) to retrieve items and shipping methods' details.\n\n:::","link":"../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.getActionsToComputeFromPromotionsStep/page.mdx","depth":5},{"type":"step","name":"prepareAdjustmentsFromPromotionActionsStep","description":"This step prepares the line item or shipping method adjustments using\nactions computed by the Promotion Module.","link":"../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.prepareAdjustmentsFromPromotionActionsStep/page.mdx","depth":5}]},{"type":"step","name":"releaseLockStep","description":"This step releases a lock for a given key. Learn more about locks in the [Locking Module](https://docs.medusajs.com/resources/infrastructure-modules/locking)\nguide.","link":"../../../../Locking/Steps_Locking/functions/core_flows.Locking.Steps_Locking.releaseLockStep/page.mdx","depth":6}]}} />

## Input

<TypeList types={[{"name":"ComputeDraftOrderAdjustmentsWorkflowInput","type":"[ComputeDraftOrderAdjustmentsWorkflowInput](../../../../interfaces/core_flows.ComputeDraftOrderAdjustmentsWorkflowInput/page.mdx)","optional":false,"defaultValue":"","description":"The details of the draft order to refresh the adjustments for.","expandable":false,"children":[{"name":"order_id","type":"`string`","description":"The ID of the draft order to refresh the adjustments for.","optional":false,"defaultValue":"","expandable":false,"children":[]}]}]} expandUrl="https://docs.medusajs.com/learn/fundamentals/data-models/manage-relationships#retrieve-records-of-relation" openedLevel={1} sectionTitle="computeDraftOrderAdjustmentsWorkflow"/>
