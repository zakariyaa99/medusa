---
slug: /references/medusa-workflows/computeAdjustmentsForPreviewWorkflow
sidebar_label: computeAdjustmentsForPreviewWorkflow
sidebar_description: Compute adjustments for an order edit, exchange, claim, or return.
tags:
  - order
  - promotion
  - query
  - workflow
---

import { TypeList, WorkflowDiagram } from "docs-ui"

# computeAdjustmentsForPreviewWorkflow - Medusa Core Workflows Reference

This documentation provides a reference to the `computeAdjustmentsForPreviewWorkflow`. It belongs to the `@medusajs/medusa/core-flows` package.

This workflow computes adjustments for an order change if the carry over promotions flag is true on the order change.
If the flag is false, it deletes the existing adjustments replacement actions.

It is currently used as a part of the order edit and exchange flows. It's used by workflows
like [orderExchangeAddNewItemWorkflow](../core_flows.Order.Workflows_Order.orderExchangeAddNewItemWorkflow/page.mdx) and [orderEditAddNewItemWorkflow](../core_flows.Order.Workflows_Order.orderEditAddNewItemWorkflow/page.mdx).

You can use this workflow within your customizations or your own custom workflows, allowing you to compute adjustments
in your custom flows.

:::note

This is available starting from [Medusa v2.12.0](https://github.com/medusajs/medusa/releases/tag/v2.12.0).

:::

<SourceCodeLink link="https://github.com/medusajs/medusa/blob/a960fb75c9f662372fd5cd623f883f9d6d8ad473/packages/core/core-flows/src/order/workflows/compute-adjustments-for-preview.ts#L77" />

## Examples

<CodeTabs group="workflow-exection">
    <CodeTab label="API Route" value="api-route">
    
```ts title="src/api/workflow/route.ts"
import type {
  MedusaRequest,
  MedusaResponse,
} from "@medusajs/framework/http"
import { computeAdjustmentsForPreviewWorkflow } from "@medusajs/medusa/core-flows"

export async function POST(
  req: MedusaRequest,
  res: MedusaResponse
) {
  const { result } = await computeAdjustmentsForPreviewWorkflow(req.scope)
    .run({
      input: {
        order: {
          id: "order_123",
          // other order details...
        },
        orderChange: {
          id: "orch_123",
          // other order change details...
        },
      }
    })

  res.send(result)
}
```

    </CodeTab>
    <CodeTab label="Subscriber" value="subscriber">
    
```ts title="src/subscribers/order-placed.ts"
import {
  type SubscriberConfig,
  type SubscriberArgs,
} from "@medusajs/framework"
import { computeAdjustmentsForPreviewWorkflow } from "@medusajs/medusa/core-flows"

export default async function handleOrderPlaced({
  event: { data },
  container,
}: SubscriberArgs < { id: string } > ) {
  const { result } = await computeAdjustmentsForPreviewWorkflow(container)
    .run({
      input: {
        order: {
          id: "order_123",
          // other order details...
        },
        orderChange: {
          id: "orch_123",
          // other order change details...
        },
      }
    })

  console.log(result)
}

export const config: SubscriberConfig = {
  event: "order.placed",
}
```

    </CodeTab>
    <CodeTab label="Scheduled Job" value="scheduled-job">
    
```ts title="src/jobs/message-daily.ts"
import { MedusaContainer } from "@medusajs/framework/types"
import { computeAdjustmentsForPreviewWorkflow } from "@medusajs/medusa/core-flows"

export default async function myCustomJob(
  container: MedusaContainer
) {
  const { result } = await computeAdjustmentsForPreviewWorkflow(container)
    .run({
      input: {
        order: {
          id: "order_123",
          // other order details...
        },
        orderChange: {
          id: "orch_123",
          // other order change details...
        },
      }
    })

  console.log(result)
}

export const config = {
  name: "run-once-a-day",
  schedule: "0 0 * * *",
}
```

    </CodeTab>
    <CodeTab label="Another Workflow" value="another-workflow">
    
```ts title="src/workflows/my-workflow.ts"
import { createWorkflow } from "@medusajs/framework/workflows-sdk"
import { computeAdjustmentsForPreviewWorkflow } from "@medusajs/medusa/core-flows"

const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    const result = computeAdjustmentsForPreviewWorkflow
      .runAsStep({
        input: {
          order: {
            id: "order_123",
            // other order details...
          },
          orderChange: {
            id: "orch_123",
            // other order change details...
          },
        }
      })
  }
)
```

    </CodeTab>
  </CodeTabs>

## Steps

<WorkflowDiagram workflow={{"name":"computeAdjustmentsForPreviewWorkflow","steps":[{"type":"step","name":"previewOrderChangeStep","description":"This step retrieves a preview of an order change.","link":"../../../Steps_Order/functions/core_flows.Order.Steps_Order.previewOrderChangeStep/page.mdx","depth":1},{"type":"when","condition":"!!order.promotions.length && !!input.orderChange.carry_over_promotions","depth":"2","steps":[{"type":"step","name":"getActionsToComputeFromPromotionsStep","description":"This step retrieves the actions to compute based on the promotions\napplied on items and shipping methods.\n\n:::tip\n\nYou can use the [retrieveCartStep](../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.retrieveCartStep/page.mdx) to retrieve items and shipping methods' details.\n\n:::","link":"../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.getActionsToComputeFromPromotionsStep/page.mdx","depth":2},{"type":"step","name":"prepareAdjustmentsFromPromotionActionsStep","description":"This step prepares the line item or shipping method adjustments using\nactions computed by the Promotion Module.","link":"../../../../Cart/Steps_Cart/functions/core_flows.Cart.Steps_Cart.prepareAdjustmentsFromPromotionActionsStep/page.mdx","depth":2}]},{"type":"when","condition":"!order.order_change.carry_over_promotions","depth":"3","steps":[{"type":"step","name":"listOrderChangeActionsByTypeStep","description":"This step lists order change actions filtered by action type.","link":"../../../Steps_Order/functions/core_flows.Order.Steps_Order.listOrderChangeActionsByTypeStep/page.mdx","depth":3},{"type":"step","name":"deleteOrderChangeActionsStep","description":"This step deletes order change actions.","link":"../../../Steps_Order/functions/core_flows.Order.Steps_Order.deleteOrderChangeActionsStep/page.mdx","depth":3}]}]}} />

## Input

<TypeList types={[{"name":"ComputeAdjustmentsForPreviewWorkflowInput","type":"[ComputeAdjustmentsForPreviewWorkflowInput](../../../../types/core_flows.ComputeAdjustmentsForPreviewWorkflowInput/page.mdx)","optional":false,"defaultValue":"","description":"The data to compute adjustments for an order edit, exchange, claim, or return.","expandable":false,"children":[{"name":"order","type":"[OrderDTO](../../../../../fulfillment/interfaces/fulfillment.OrderDTO/page.mdx) & `object`","description":"The order's details.","optional":false,"defaultValue":"","expandable":false,"children":[{"name":"id","type":"`string`","description":"The ID of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"version","type":"`number`","description":"The version of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"display_id","type":"`number`","description":"The order's display ID.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"status","type":"[OrderStatus](../../../../../fulfillment/types/fulfillment.OrderStatus/page.mdx)","description":"The status of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"currency_code","type":"`string`","description":"The currency of the order","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"created_at","type":"`string` \\| `Date`","description":"When the order was created.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"updated_at","type":"`string` \\| `Date`","description":"When the order was updated.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_item_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original item total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_item_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original item subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_item_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original item tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"item_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The item total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"item_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The item subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"item_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The item tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"item_discount_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The item discount total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The subtotal of the order. (Excluding taxes)","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"discount_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The discount subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"discount_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The discount total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"discount_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The discount tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"credit_line_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The credit line total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"gift_card_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The gift card total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"gift_card_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The gift card tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"shipping_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The shipping total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"shipping_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The shipping subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"shipping_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The shipping tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"shipping_discount_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The shipping discount total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_shipping_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original shipping total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_shipping_subtotal","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original shipping subtotal of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"original_shipping_tax_total","type":"[BigNumberValue](../../../../../fulfillment/types/fulfillment.BigNumberValue/page.mdx)","description":"The original shipping tax total of the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"promotions","type":"[PromotionDTO](../../../../../promotion/interfaces/promotion.PromotionDTO/page.mdx)[]","description":"The promotions applied to the order.","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"custom_display_id","type":"`string`","description":"The order's custom display ID.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"order_change","type":"[OrderChangeDTO](../../../../../fulfillment/interfaces/fulfillment.OrderChangeDTO/page.mdx)","description":"The active order change, if any.","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"region_id","type":"`string`","description":"The ID of the region the order belongs to.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"customer_id","type":"`string`","description":"The ID of the customer on the order.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"sales_channel_id","type":"`string`","description":"The ID of the sales channel the order belongs to.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"email","type":"`string`","description":"The email of the order.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"shipping_address","type":"[OrderAddressDTO](../../../../../fulfillment/interfaces/fulfillment.OrderAddressDTO/page.mdx)","description":"The associated shipping address.","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"billing_address","type":"[OrderAddressDTO](../../../../../fulfillment/interfaces/fulfillment.OrderAddressDTO/page.mdx)","description":"The associated billing address.","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"items","type":"[OrderLineItemDTO](../../../../../fulfillment/interfaces/fulfillment.OrderLineItemDTO/page.mdx)[]","description":"The associated order details / line items.","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"shipping_methods","type":"[OrderShippingMethodDTO](../../../../../fulfillment/interfaces/fulfillment.OrderShippingMethodDTO/page.mdx)[]","description":"The associated shipping methods","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"transactions","type":"[OrderTransactionDTO](../../../../../fulfillment/interfaces/fulfillment.OrderTransactionDTO/page.mdx)[]","description":"The tramsactions associated with the order","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"credit_lines","type":"[OrderCreditLineDTO](../../../../../fulfillment/interfaces/fulfillment.OrderCreditLineDTO/page.mdx)[]","description":"The credit lines for an order","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"summary","type":"[OrderSummaryDTO](../../../../../fulfillment/interfaces/fulfillment.OrderSummaryDTO/page.mdx)","description":"The summary of the order totals.","optional":true,"defaultValue":"","expandable":true,"children":[]},{"name":"is_draft_order","type":"`boolean`","description":"Whether the order is a draft order.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"locale","type":"`null` \\| `string`","description":"The locale of the order.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"metadata","type":"`null` \\| `Record<string, unknown>`","description":"Holds custom data in key-value pairs.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"canceled_at","type":"`string` \\| `Date`","description":"When the order was canceled.","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"deleted_at","type":"`string` \\| `Date`","description":"When the order was deleted.","optional":true,"defaultValue":"","expandable":false,"children":[]}]},{"name":"orderChange","type":"[OrderChangeDTO](../../../../../fulfillment/interfaces/fulfillment.OrderChangeDTO/page.mdx)","description":"The order change's details.","optional":false,"defaultValue":"","expandable":false,"children":[{"name":"id","type":"`string`","description":"The ID of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"version","type":"`number`","description":"The version of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"order_id","type":"`string`","description":"The ID of the associated order","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"return_id","type":"`string`","description":"The ID of the associated return order","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"exchange_id","type":"`string`","description":"The ID of the associated exchange order","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"claim_id","type":"`string`","description":"The ID of the associated claim order","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"order","type":"[OrderDTO](../../../../../fulfillment/interfaces/fulfillment.OrderDTO/page.mdx)","description":"The associated order","optional":false,"defaultValue":"","expandable":true,"children":[]},{"name":"return_order","type":"[ReturnDTO](../../../../../fulfillment/interfaces/fulfillment.ReturnDTO/page.mdx)","description":"The associated return order","optional":false,"defaultValue":"","expandable":true,"children":[]},{"name":"exchange","type":"[OrderExchangeDTO](../../../../../fulfillment/interfaces/fulfillment.OrderExchangeDTO/page.mdx)","description":"The associated exchange order","optional":false,"defaultValue":"","expandable":true,"children":[]},{"name":"claim","type":"[OrderClaimDTO](../../../../../fulfillment/interfaces/fulfillment.OrderClaimDTO/page.mdx)","description":"The associated claim order","optional":false,"defaultValue":"","expandable":true,"children":[]},{"name":"actions","type":"[OrderChangeActionDTO](../../../../../fulfillment/interfaces/fulfillment.OrderChangeActionDTO/page.mdx)[]","description":"The actions of the order change","optional":false,"defaultValue":"","expandable":true,"children":[]},{"name":"status","type":"[OrderChangeStatus](../../../../../fulfillment/types/fulfillment.OrderChangeStatus/page.mdx)","description":"The status of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"requested_by","type":"`null` \\| `string`","description":"The requested by of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"requested_at","type":"`null` \\| `string` \\| `Date`","description":"When the order change was requested","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"confirmed_by","type":"`null` \\| `string`","description":"The confirmed by of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"confirmed_at","type":"`null` \\| `string` \\| `Date`","description":"When the order change was confirmed","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"declined_by","type":"`null` \\| `string`","description":"The declined by of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"declined_reason","type":"`null` \\| `string`","description":"The declined reason of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"metadata","type":"`null` \\| `Record<string, unknown>`","description":"The metadata of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"declined_at","type":"`null` \\| `string` \\| `Date`","description":"When the order change was declined","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"canceled_by","type":"`null` \\| `string`","description":"The canceled by of the order change","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"canceled_at","type":"`null` \\| `string` \\| `Date`","description":"When the order change was canceled","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"created_at","type":"`string` \\| `Date`","description":"When the order change was created","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"updated_at","type":"`string` \\| `Date`","description":"When the order change was updated","optional":false,"defaultValue":"","expandable":false,"children":[]},{"name":"change_type","type":"`\"return\"` \\| `\"exchange\"` \\| `\"claim\"` \\| `\"edit\"` \\| `\"transfer\"`","description":"The type of the order change","optional":true,"defaultValue":"","expandable":false,"children":[]},{"name":"carry_over_promotions","type":"`null` \\| `boolean`","description":"Whether to carry over promotions (apply promotions to outbound exchange items).","optional":true,"defaultValue":"","expandable":false,"children":[]}]}]}]} expandUrl="https://docs.medusajs.com/learn/fundamentals/data-models/manage-relationships#retrieve-records-of-relation" openedLevel={1} sectionTitle="computeAdjustmentsForPreviewWorkflow"/>
