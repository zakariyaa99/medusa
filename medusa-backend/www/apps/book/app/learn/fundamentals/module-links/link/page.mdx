import { CodeTab, CodeTabs } from "docs-ui"

export const metadata = {
  title: `${pageNumber} Link`,
}

# {metadata.title}

In this chapter, you’ll learn what Link is and how to use it to manage links.

<Note>

As of [Medusa v2.2.0](https://github.com/medusajs/medusa/releases/tag/v2.2.0), Remote Link has been deprecated in favor of Link. They have the same usage, so you only need to change the key used to resolve the tool from the Medusa container as explained below.

</Note>

## What is Link?

Link is a class with utility methods to manage links between data models. It’s registered in the Medusa container under the `link` registration name.

For example:

```ts collapsibleLines="1-9" expandButtonLabel="Show Imports"
import { 
  MedusaRequest, 
  MedusaResponse,
} from "@medusajs/framework/http"
import { 
  ContainerRegistrationKeys,
} from "@medusajs/framework/utils"

export async function POST(
  req: MedusaRequest,
  res: MedusaResponse
): Promise<void> {
  const link = req.scope.resolve(
    ContainerRegistrationKeys.LINK
  )
    
  // ...
}
```

You can use its methods to manage links, such as create or delete links.

### Link Usage in Workflows

To perform link operations in a [workflow](../../workflows/page.mdx), Medusa provides the following steps out-of-the-box:

- [createRemoteLinkStep](!resources!/references/helper-steps/createRemoteLinkStep): Creates a link between records of two data models.
- [dismissRemoteLinkStep](!resources!/references/helper-steps/dismissRemoteLinkStep): Removes a link between records of two data models.
- [removeRemoteLinkStep](!resources!/references/helper-steps/removeRemoteLinkStep): Deletes all linked records whose links are defined with cascade deletion.
- [updateRemoteLinksStep](!resources!/references/helper-steps/updateRemoteLinksStep): Updates links between records of two data models.

The rest of this chapter provides examples using the Link class and the workflow steps.

---

## Create Link

To create a link between records of two data models, use the `create` method of Link.

For example:

<CodeTabs group="link">
  <CodeTab label="Link" value="link">

```ts
import { Modules } from "@medusajs/framework/utils"

// ...

await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "post_123",
  },
})
```

  </CodeTab>
  <CodeTab label="createRemoteLinkStep" value="createRemoteLinkStep">

```ts
import { Modules } from "@medusajs/framework/utils"
import { createRemoteLinkStep } from "@medusajs/medusa/core-flows"
import { 
  createWorkflow,
  transform,
} from "@medusajs/framework/workflows-sdk"

export const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    // ...
    const linkData = transform({
      // TODO pass input data
    }, () => {
      return [
        {
          [Modules.PRODUCT]: {
            product_id: "prod_123",
          },
          blog: {
            post_id: "post_123",
          },
        },
      ]
    })
    createRemoteLinkStep(linkData)
    // ...
  }
)
```

  </CodeTab>
</CodeTabs>

The `create` method accepts as a parameter an object. The object’s keys are the names of the linked modules.

<Note title="Important">

The keys (names of linked modules) must be in the same [direction](../directions/page.mdx) of the link definition.

</Note>

The value of each module’s property is an object, whose keys are of the format `{data_model_snake_name}_id`, and values are the IDs of the linked record.

So, in the example above, you link a record of the `Post` data model in a `blog` module to a `Product` record in the Product Module.

### Enforced Integrity Constraints on Link Creation

Medusa enforces integrity constraints on links based on the link's relation type. So, an error is thrown in the following scenarios:

- If the link is one-to-one and one of the linked records already has a link to another record of the same data model. For example:

```ts
// no error
await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "post_123",
  },
})

// throws an error because `prod_123` already has a link to `post_123`
await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "mc_456",
  },
})
```

- If the link is one-to-many and the "one" side already has a link to another record of the same data model. For example, if a product can have many `Post` records, but a `Post` record can only have one product:

```ts
// no error
await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "post_123",
  },
})

// also no error
await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "mc_456",
  },
})

// throws an error because `post_123` already has a link to `prod_123`
await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_456",
  },
  blog: {
    post_id: "post_123",
  },
})
```

There are no integrity constraints in a many-to-many link, so you can create multiple links between the same records.

---

## Dismiss Link

To remove a link between records of two data models, use the `dismiss` method of Link.

For example:

<CodeTabs group="link">
  <CodeTab label="Link" value="link">

```ts
import { Modules } from "@medusajs/framework/utils"

// ...

await link.dismiss({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "post_123",
  },
})
```

  </CodeTab>
  <CodeTab label="dismissRemoteLinkStep" value="dismissRemoteLinkStep">

```ts
import { Modules } from "@medusajs/framework/utils"
import { dismissRemoteLinkStep } from "@medusajs/medusa/core-flows"
import { 
  createWorkflow,
  transform,
} from "@medusajs/framework/workflows-sdk"

export const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    // ...
    const linkData = transform({
      // TODO pass input data
    }, () => {
      return [
        {
          [Modules.PRODUCT]: {
            product_id: "prod_123",
          },
          blog: {
            post_id: "post_123",
          },
        },
      ]
    })
    dismissRemoteLinkStep(linkData)
    // ...
  }
)
```

  </CodeTab>
</CodeTabs>

The `dismiss` method accepts the same parameter type as the [create method](#create-link).

<Note title="Important">

The keys (names of linked modules) must be in the same [direction](../directions/page.mdx) of the link definition.

</Note>

---

## Cascade Delete Linked Records

If you delete a record using a workflow or its module's service, use the `delete` method of Link to delete all linked records whose links are defined with [cascade deletion](../page.mdx#set-delete-cascades-on-link).

For example:

<CodeTabs group="link">
  <CodeTab label="Link" value="link">

```ts
import { Modules } from "@medusajs/framework/utils"

// ...

await productModuleService.deleteProducts(["prod_123"])

await link.delete({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
})
```

  </CodeTab>
  <CodeTab label="removeRemoteLinkStep" value="removeRemoteLinkStep">

```ts
import { Modules } from "@medusajs/framework/utils"
import { removeRemoteLinkStep } from "@medusajs/medusa/core-flows"
import { 
  createWorkflow,
  transform,
} from "@medusajs/framework/workflows-sdk"

export const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    // ...
    const linkData = transform({
      // TODO pass input data
    }, () => {
      return [
        {
          [Modules.PRODUCT]: {
            product_id: "prod_123",
          },
        },
      ]
    })
    removeRemoteLinkStep(linkData)
    // ...
  }
)
```

  </CodeTab>
</CodeTabs>

This deletes all records linked to the deleted product.

---

## Restore Linked Records

If a record that was previously soft-deleted is now restored, use the `restore` method of Link to restore all linked records.

For example:

```ts
import { Modules } from "@medusajs/framework/utils"

// ...

await productModuleService.restoreProducts(["prod_123"])

await link.restore({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
})
```

---

## Update Links

Links may have [custom columns](../custom-columns/page.mdx) to store additional information, such as a `metadata` column to store JSON data about the link.

You can update the custom columns of existing links by calling the `create` method again with the same linked records and the new values for the custom columns.

For example:

<CodeTabs group="link">
  <CodeTab label="Link" value="link">

```ts
import { Modules } from "@medusajs/framework/utils"

// ...

await link.create({
  [Modules.PRODUCT]: {
    product_id: "prod_123",
  },
  blog: {
    post_id: "post_123",
  },
  data: {
    metadata: {
      featured: true,
    },
  },
})
```

  </CodeTab>
  <CodeTab label="updateRemoteLinksStep" value="updateRemoteLinksStep">

```ts
import { Modules } from "@medusajs/framework/utils"
import { updateRemoteLinksStep } from "@medusajs/medusa/core-flows"
import { 
  createWorkflow,
  transform,
} from "@medusajs/framework/workflows-sdk"

export const myWorkflow = createWorkflow(
  "my-workflow",
  () => {
    // ...
    const linkData = transform({
      // TODO pass input data
    }, () => {
      return [
        {
          [Modules.PRODUCT]: {
            product_id: "prod_123",
          },
          blog: {
            post_id: "post_123",
          },
          data: {
            metadata: {
              featured: true,
            },
          },
        },
      ]
    })
    updateRemoteLinksStep(linkData)
    // ...
  }
)
```

  </CodeTab>
</CodeTabs>

The object parameter you pass to the `create` method (or the `updateRemoteLinksStep` step) accepts an optional `data` property. The value of this property is an object whose keys are the names of the custom columns to update, and values are the new values for those columns.

Learn more in the [Custom Columns](../custom-columns/page.mdx) chapter.